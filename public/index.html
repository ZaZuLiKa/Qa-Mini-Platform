<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Mini Platform - Checklists</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .feature-selection, .checklist-editor { margin-bottom: 40px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        .checklist-item { margin-bottom: 10px; padding: 5px; border: 1px dashed #eee; display: flex; align-items: center; }
        .checklist-item button { margin-left: 10px; cursor: pointer; background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; }
        .feature-title { font-weight: bold; margin-top: 15px; border-bottom: 2px solid #333; padding-bottom: 5px; }
        #checklist-editor { display: none; }
    </style>
</head>
<body>

<h1>QA მინი პლატფორმა</h1>

<div class="feature-selection">
    <h2>1. ფუნქციონალის შერჩევა</h2>
    <form id="feature-selection-form">
        <label><input type="checkbox" name="features" value="Cart"> Cart</label><br>
        <label><input type="checkbox" name="features" value="Register"> Register</label><br>
        <label><input type="checkbox" name="features" value="Authorization"> Authorization</label><br>
        <label><input type="checkbox" name="features" value="Search"> Search</label><br>
        <label><input type="checkbox" name="features" value="Filter"> Filter</label><br>
        <label><input type="checkbox" name="features" value="Sort"> Sort</label><br>
        <label><input type="checkbox" name="features" value="Contact us"> Contact us</label><br>
        <label><input type="checkbox" name="features" value="Subscribe"> Subscribe</label><br>
        <br>
        <button type="button" onclick="getChecklists()">ჩექლისტების გენერაცია</button>
    </form>
</div>

<div id="checklist-editor" class="checklist-editor">
    <h2>2. ჩექლისტების რედაქტირება</h2>
    <p>თქვენ შეგიძლიათ წაშალოთ არასასურველი ჩექლისტები.</p>
    <div id="checklists-container"></div>
    <button onclick="confirmSelection()">Confirm</button>
</div>

<script>
let currentChecklists = [];
const checklistContainer = document.getElementById('checklists-container');
const editorSection = document.getElementById('checklist-editor');

async function getChecklists() {
    const form = document.getElementById('feature-selection-form');
    const selectedFeatures = Array.from(form.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);

    if (!selectedFeatures.length) {
        alert('გთხოვთ, აირჩიოთ მინიმუმ ერთი ფუნქციონალი.');
        return;
    }

    try {
        const response = await fetch('/api/get-checklists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ features: selectedFeatures }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
            currentChecklists = data.checklists;
            displayChecklists(currentChecklists);
            editorSection.style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        } else alert(data.error || 'სერვერის შეცდომა');
    } catch (error) {
        console.error(error);
        alert('კომუნიკაციის შეცდომა სერვერთან.');
    }
}

function displayChecklists(checklists) {
    document.querySelector('.feature-selection').style.display = 'none';
    checklistContainer.innerHTML = '';
    let currentFeature = null;

    checklists.forEach(item => {
        if (item.feature !== currentFeature) {
            const title = document.createElement('h3');
            title.className = 'feature-title';
            title.textContent = `${item.feature} ფუნქციონალი`;
            checklistContainer.appendChild(title);
            currentFeature = item.feature;
        }

        const itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';
        itemDiv.id = `item-${item.id}`;
        
        const textSpan = document.createElement('span');
        textSpan.textContent = `(${item.id}) ${item.text}`;
        itemDiv.appendChild(textSpan);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'წაშლა';
        deleteButton.onclick = () => removeChecklistItem(item.id);
        itemDiv.appendChild(deleteButton);

        checklistContainer.appendChild(itemDiv);
    });
}

function removeChecklistItem(idToRemove) {
    currentChecklists = currentChecklists.filter(item => item.id !== idToRemove);
    const element = document.getElementById(`item-${idToRemove}`);
    if (element) element.remove();
}

async function confirmSelection() {
    if (!currentChecklists.length) { alert('არჩეული ჩექლისტები არ არის'); return; }

    try {
        const response = await fetch('/api/save-selection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ checklists: currentChecklists }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
            window.location.href = `/test-page/${data.sessionId}`;
        } else alert('შეცდომა მონაცემების შენახვისას');
    } catch (error) {
        console.error(error);
        alert('კომუნიკაციის შეცდომა.');
    }
}
</script>

</body>
</html>
