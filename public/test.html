<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <title>QA Mini Platform - ტესტირება</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .checklist-item { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-details { flex-grow: 1; }
        .item-details span { font-weight: bold; margin-right: 10px; }
        .actions { display: flex; align-items: center; }
        .status-pass { background-color: #d4edda; color: #155724; }
        .status-fail { background-color: #f8d7da; color: #721c24; }
        .status-pending { background-color: #ffeeba; color: #856404; }
        .actions button { margin-left: 5px; padding: 8px 12px; cursor: pointer; }
        #bug-report-section { display: none; margin-top: 10px; }
        .feature-title { font-weight: bold; border-bottom: 1px solid #aaa; margin-top: 20px; padding-bottom: 5px; }
        .rtm-bug-id { color: red; font-weight: bold; }

        /* Modal */
        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
        #checklist-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:white; padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:1000; max-width:400px; }
    </style>
</head>
<body>

    <h1>3. ტესტირების შესრულება</h1>
    <h3 id="session-info">სესიის ID: <span id="session-id"></span></h3>

    <div id="checklists-test-container">
        <p>იტვირთება ჩექლისტები...</p>
    </div>

    <button id="button-GenerateRTMOnC"onclick="generateReport()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; margin-top: 30px; cursor: pointer;">Report-ის გენერაცია (RTM)</button>

    <div id="report-output" style="margin-top: 40px; display: none; border: 1px solid #000; padding: 20px;"></div>

    <!-- Modal -->
    <div id="modal-overlay"></div>
    <div id="checklist-modal">
        <div id="modal-content"></div>
        <button onclick="closeModal()" style="margin-top:10px;padding:5px 10px;">Close</button>
    </div>

    <script>
        let currentSessionId = null;
        let testData = [];

        document.addEventListener('DOMContentLoaded', () => {
            const pathParts = window.location.pathname.split('/');
            currentSessionId = pathParts[pathParts.length - 1];
            document.getElementById('session-id').textContent = currentSessionId;

            if(currentSessionId) fetchTestData();
            else document.getElementById('checklists-test-container').innerHTML = '<p style="color:red;">შეცდომა: სესიის ID ვერ მოიძებნა.</p>';
        });

        async function fetchTestData() {
            try {
                const response = await fetch(`/api/get-test-data/${currentSessionId}`);
                const data = await response.json();

                if(response.ok && data.success){
                    testData = data.testData;
                    displayTestChecklists();
                } else alert('ტესტ-მონაცემების მოტანა ვერ მოხერხდა: ' + data.error);
            } catch(error) {
                console.error('Fetch Error:', error);
                alert('კომუნიკაციის შეცდომა სერვერთან.');
            }
        }

        function displayTestChecklists() {
            const container = document.getElementById('checklists-test-container');
            container.innerHTML = '';
            let currentFeature = null;

            testData.forEach(item => {
                if(item.feature !== currentFeature){
                    const title = document.createElement('h3');
                    title.className = 'feature-title';
                    title.textContent = `ფუნქციონალი: ${item.feature}`;
                    container.appendChild(title);
                    currentFeature = item.feature;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = `checklist-item status-${item.status.toLowerCase()}`;
                itemDiv.id = `test-item-${item.id}`;

                const details = document.createElement('div');
                details.className = 'item-details';
                details.innerHTML = `<span>(${item.id})</span> ${item.text} 
                    <small style="color: gray;">[სტატუსი: ${item.status}] ${item.bugId ? `(Bug ID: ${item.bugId})` : ''}</small>`;
                itemDiv.appendChild(details);

                const actions = document.createElement('div');
                actions.className = 'actions';

                const passBtn = document.createElement('button');
                passBtn.textContent = 'Pass';
                passBtn.onclick = () => updateTestStatus(item.id,'Pass');

                const failBtn = document.createElement('button');
                failBtn.textContent = 'Failed';
                failBtn.onclick = () => showBugInput(item.id);

                actions.appendChild(passBtn);
                actions.appendChild(failBtn);

                const bugInput = document.createElement('div');
                bugInput.id = `bug-input-${item.id}`;
                bugInput.style.display = 'none';
                bugInput.innerHTML = `<input type="text" placeholder="Bug ID (მაგ: BUG-001)" id="bug-id-${item.id}" style="margin-left: 10px;"/>
                                      <button onclick="updateTestStatus('${item.id}','Failed',document.getElementById('bug-id-${item.id}').value)">შენახვა</button>`;
                
                actions.appendChild(bugInput);
                itemDiv.appendChild(actions);

                container.appendChild(itemDiv);
            });
        }

        function showBugInput(id) {
            document.querySelectorAll('[id^="bug-input-"]').forEach(el=>el.style.display='none');
            const bugSection = document.getElementById(`bug-input-${id}`);
            if(bugSection) bugSection.style.display='block';
        }

        function updateTestStatus(id,status,bugId=null){
            const index = testData.findIndex(item=>item.id===id);
            if(index!==-1){
                testData[index].status=status;
                testData[index].bugId=status==='Failed'? (bugId||'N/A'):null;
                saveTestStatusUpdate(id,status,testData[index].bugId);
                displayTestChecklists();
            }
        }

        async function saveTestStatusUpdate(checklistItemId,status,bugId){
            try{
                const response = await fetch('/api/update-status',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        sessionId:currentSessionId,
                        checklistItemId,
                        status,
                        bugId
                    })
                });
                const data = await response.json();
                if(!response.ok || !data.success) alert('შეცდომა სტატუსის შენახვისას.');
            }catch(error){console.error('Save status error:',error);}
        }

        function closeModal(){
            document.getElementById('checklist-modal').style.display='none';
            document.getElementById('modal-overlay').style.display='none';
        }

        function generateReport(){
            document.querySelector('#checklists-test-container').style.display = 'none';
            document.querySelector('#button-GenerateRTMOnC').style.display = 'none';
            //document.querySelector('#hiddenGeneratePdf').style.display = 'visible';
            let element = document.getElementById("hiddenGeneratePdf");
            let hidden = element.getAttribute("hidden");
            element.removeAttribute("hidden");
            let passedCount=0, failedCount=0;
            const totalCount=testData.length;
            let reportRows='';

            testData.forEach(item=>{
                if(item.status==='Pass') passedCount++;
                else if(item.status==='Failed') failedCount++;

                const bugIdDisplay=item.bugId||'-';
                const statusClass=`class="status-${item.status.toLowerCase()}"`;

                reportRows+=`
                    <tr>
                        <td>${item.feature}</td>
                        <td><a href="#" class="checklist-id"
                               data-id="${item.id}"
                               data-feature="${item.feature}"
                               data-text="${item.text}"
                               data-status="${item.status}"
                               data-bug="${bugIdDisplay}">${item.id}</a></td>
                        <td ${item.status==='Failed'?'class="rtm-bug-id"':''}>
    ${item.status==='Failed' ? `<a href="${bugIdDisplay}" target="_blank">${bugIdDisplay}</a>` : bugIdDisplay}
</td>

                        <td ${statusClass}>${item.status}</td>
                    </tr>
                `;
            });

            const pendingCount=totalCount-passedCount-failedCount;
            const passPercent=totalCount>0?((passedCount/totalCount)*100).toFixed(1):0;
            const failPercent=totalCount>0?((failedCount/totalCount)*100).toFixed(1):0;

            const summaryHTML=`
                <p><strong>რეპორტის გენერირების დრო:</strong> ${new Date().toLocaleString()}</p>
                <p>
                    სულ: <strong>${totalCount}</strong> | 
                    ✅ Pass: <strong>${passedCount}</strong> (${passPercent}%) | 
                    ❌ Failed: <strong>${failedCount}</strong> (${failPercent}%) |
                    ⏳ Pending: <strong>${pendingCount}</strong>
                </p>
            `;
                
            const reportDiv=document.getElementById('report-output');
            reportDiv.style.display='block';
            reportDiv.innerHTML=`
                <h2>მოთხოვნების მიკვლევადობის მატრიცა (RTM)</h2>
                <div class="summary">${summaryHTML}</div>
                <table width="100%" border="1" cellpadding="8" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ფუნქციონალი</th>
                            <th>ჩექლისტის ID</th>
                            <th>ბაგ რეპორტის ID</th>
                            <th>სტატუსი</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportRows}
                    </tbody>
                </table>
            `;

            // ID click -> modal
            document.querySelectorAll('.checklist-id').forEach(el=>{
                el.onclick=function(e){
                    e.preventDefault();
                    const content=`
                        <p><strong>Feature:</strong> ${this.dataset.feature}</p>
                        <p><strong>Checklist ID:</strong> ${this.dataset.id}</p>
                        <p><strong>Text:</strong> ${this.dataset.text}</p>
                        <p><strong>Status:</strong> ${this.dataset.status}</p>
                        <p><strong>Bug ID:</strong> ${this.dataset.bug}</p>
                    `;
                    document.getElementById('modal-content').innerHTML=content;
                    document.getElementById('checklist-modal').style.display='block';
                    document.getElementById('modal-overlay').style.display='block';
                }
            });
        }
        async function downloadReportAsPDF() {
    const reportDiv = document.getElementById('report-output');
    if (!reportDiv || reportDiv.innerHTML.trim() === '') {
        alert('Report ჯერ არ არის გენერირებული.');
        return;
    }

    // HTML -> Canvas
    const canvas = await html2canvas(reportDiv, { scale: 2 }); // უკეთესი ხარისხი
    const imgData = canvas.toDataURL('image/png');

    // PDF შექმნა
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`QA_Report_${currentSessionId}.pdf`);
}

    </script>
    <button id="hiddenGeneratePdf"  hidden onclick="downloadReportAsPDF()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; margin-top: 10px; cursor: pointer;">Download PDF</button>


</body>
</html>
